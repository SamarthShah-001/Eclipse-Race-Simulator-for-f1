<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eclipse Racing Simulator</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Load Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      /* Simple font loading */
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=Roboto+Mono:wght@400;700&display=swap');
      body {
        font-family: 'Inter', sans-serif;
        /* Prevent scrollbars */
        overflow: hidden;
      }
      .font-mono {
        font-family: 'Roboto Mono', monospace;
      }
    </style>
  </head>
  <body>
    <!-- This is where our React app will live -->
    <div id="root"></div>

    <!-- 4. Our entire React application -->
    <script type="text/babel">
      // Re-define React imports for this no-npm environment
      const { useState, useEffect, useMemo, useRef } = React;

      // --- SVG ICONS (Replaced lucide-react) ---
      // This makes the project dependency-free
      const SVGIcons = {
        FastForward: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 19 22 12 13 5 13 19"></polygon><polygon points="2 19 11 12 2 5 2 19"></polygon></svg>,
        Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>,
        Pause: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>,
        RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>,
        Gauge: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 12m-10 0a10 10 0 1 0 20 0a10 10 0 1 0 -20 0"></path><path d="M12 12l4 0"></path><path d="M13.41 10.59l3.3 -3.3"></path><path d="M16.7 7.3l-3.3 3.3"></path><path d="M10.59 13.41l-3.3 3.3"></path><path d="M7.3 16.7l3.3 -3.3"></path></svg>,
        Zap: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>,
        ArrowRightCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 16 16 12 12 8"></polyline><line x1="8" y1="12" x2="16" y2="12"></line></svg>,
        Flag: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>,
      };
      
      // --- CONSTANTS ---

      const TRACK_WIDTH = 1000;
      const TRACK_HEIGHT = 600;
      const CAR_WIDTH = 28;
      const CAR_HEIGHT = 14;
      const TOTAL_LAPS = 10;

      // A Monza-like SVG path
      const TRACK_PATH_DATA =
        "M 100,200 \
        C 100,100 300,100 400,200 \
        S 500,300 600,200 \
        L 850,200 \
        C 950,200 950,300 850,300 \
        L 600,300 \
        C 550,300 550,400 600,400 \
        L 850,400 \
        C 950,400 950,500 850,500 \
        L 150,500 \
        C 50,500 50,200 100,200 Z";

      const INITIAL_CAR_DATA = [
        {
          id: 1,
          driver: "ALONSO",
          color: "#DC2626", // red-600
          baseSpeed: 1.2,
          speedVariation: 0.3,
          energy: 92,
          overtakes: 2,
          pitStop: false,
        },
        {
          id: 2,
          driver: "Bear",
          color: "#2563EB", // blue-600
          baseSpeed: 1.18,
          speedVariation: 0.4,
          energy: 88,
          overtakes: 1,
          pitStop: false,
        },
        {
          id: 3,
          driver: "Ocon",
          color: "#F59E0B", // amber-500
          baseSpeed: 1.16,
          speedVariation: 0.5,
          energy: 95,
          overtakes: 0,
          pitStop: false,
        },
        {
          id: 4,
          driver: "Lec",
          color: "#10B981", // emerald-500
          baseSpeed: 1.14,
          speedVariation: 0.6,
          energy: 85,
          overtakes: 3,
          pitStop: false,
        },
        {
          id: 5,
          driver: "VERST",
          color: "#EA580C", // orange-600
          baseSpeed: 1.22,
          speedVariation: 0.2,
          energy: 90,
          overtakes: 1,
          pitStop: false,
        },
      ];

      // --- UTILITY FUNCTIONS ---

      // Simple time formatter
      const formatTime = (timeMs) => {
        const minutes = Math.floor(timeMs / 60000);
        const seconds = Math.floor((timeMs % 60000) / 1000);
        const milliseconds = Math.floor((timeMs % 1000) / 10);
        return `${minutes}:${seconds.toString().padStart(2, "0")}.${milliseconds
          .toString()
          .padStart(2, "0")}`;
      };

      // --- REACT COMPONENTS ---

      /**
       * Custom hook for the game loop
       */
      const useGameLoop = (callback, isRunning) => {
        const requestRef = useRef();
        const previousTimeRef = useRef();

        const animate = (time) => {
          if (previousTimeRef.current !== undefined) {
            const deltaTime = time - previousTimeRef.current;
            callback(deltaTime);
          }
          previousTimeRef.current = time;
          requestRef.current = requestAnimationFrame(animate);
        };

        useEffect(() => {
          if (isRunning) {
            requestRef.current = requestAnimationFrame(animate);
          } else {
            cancelAnimationFrame(requestRef.current);
            previousTimeRef.current = undefined;
          }
          return () => cancelAnimationFrame(requestRef.current);
        }, [isRunning, callback]);
      };

      /**
       * Represents a single car on the track
       */
      const Car = ({ x, y, rotation, color, driverName }) => (
        <g transform={`translate(${x}, ${y}) rotate(${rotation})`}>
          {/* Rear Wing */}
          <path d="M -12 -6 L -8 -6 L -8 6 L -12 6 Z" fill="#222" />
          {/* Body */}
          <path
            d="M -10 -4 L 8 -4 L 12 0 L 8 4 L -10 4 Z"
            fill={color}
            stroke="#171717"
            strokeWidth="1"
          />
          {/* Front Wing */}
          <path d="M 8 -5 L 14 -5 L 14 5 L 8 5 Z" fill="#222" />
          {/* Driver Helmet */}
          <circle cx="0" cy="0" r="2.5" fill="#FFFFFF" stroke="#000" strokeWidth="0.5" />
          <text
            x="0"
            y="-10"
            fill="#FFFFFF"
            fontSize="10"
            textAnchor="middle"
            className="font-mono"
          >
            {driverName.substring(0, 3)}
          </text>
        </g>
      );


      /**
       * The SVG Race Track
       */
      const RaceTrack = ({ children }) => {
        return (
          <svg
            viewBox={`0 0 ${TRACK_WIDTH} ${TRACK_HEIGHT}`}
            className="w-full h-full bg-gray-300"
            style={{
              backgroundImage:
                "url('https://placehold.co/1000x600/34D399/1F2937?font=inter')",
              backgroundSize: "cover",
            }}
          >
            {/* Track Outline */}
            <path
              d={TRACK_PATH_DATA}
              fill="#4A4A4A"
              stroke="#333333"
              strokeWidth="50"
              strokeLinejoin="round"
            />
            {/* Finish Line */}
            <line
              x1="100"
              y1="175"
              x2="100"
              y2="225"
              stroke="#FFFFFF"
              strokeWidth="5"
              strokeDasharray="10 5"
            />
            {/* Cars are rendered as children */}
            {children}
          </svg>
        );
      };

      /**
       * The Live Analytics HUD
       */
      const RaceHUD = ({
        lap,
        leaderboard,
        playerCar,
        onSimControl,
        simSpeed,
        isPaused,
      }) => {
        const playerStats = playerCar || {
          speedKmh: 0,
          energy: 0,
          overtakes: 0,
          pitStop: false,
        };

        const sortedLeaderboard = useMemo(
          () => [...leaderboard].sort((a, b) => {
              if (a.lap !== b.lap) return b.lap - a.lap; // Higher lap is better
              if (a.lap === b.lap) return a.totalTime - b.totalTime; // Lower time is better
              return 0;
          }),
          [leaderboard]
        );

        const bestTime =
          sortedLeaderboard.length > 0 ? sortedLeaderboard[0].totalTime : 0;

        return (
          // HUD moved to top-right and scaled to 50%
          <div
            className="absolute top-4 right-4 w-80 h-auto bg-gray-900 bg-opacity-80 backdrop-blur-sm text-white font-mono rounded-lg p-4 shadow-2xl border border-gray-700"
            style={{ transform: "scale(0.5)", transformOrigin: "top right" }} 
          >
            {/* Header */}
            <h2 className="text-xl font-bold uppercase tracking-wider border-b border-gray-600 pb-2 mb-3">
              Live Analytics
            </h2>

            {/* Lap Counter */}
            <div className="flex justify-between items-center mb-3">
              <span className="text-lg">LAP</span>
              <span className="text-2xl font-bold">
                {lap} / {TOTAL_LAPS}
              </span>
            </div>

            {/* Leaderboard */}
            <div className="space-y-1 mb-4">
              {sortedLeaderboard.map((car, index) => (
                <div
                  key={car.id}
                  className={`flex justify-between items-baseline p-2 rounded ${
                    car.id === 1 ? "bg-red-600 bg-opacity-50" : ""
                  }`}
                >
                  <div className="flex items-center">
                    <span className="text-lg w-6">{index + 1}</span>
                    <span
                      className="w-3 h-3 rounded-full mr-2"
                      style={{ backgroundColor: car.color }}
                    ></span>
                    <span className="text-lg uppercase">{car.driver}</span>
                  </div>
                  <span className="text-lg">
                    {index === 0
                      ? formatTime(car.totalTime)
                      : `+${formatTime(car.totalTime - bestTime)}`}
                  </span>
                </div>
              ))}
            </div>

            {/* Player Stats */}
            <div className="grid grid-cols-2 gap-4 border-t border-gray-600 pt-4">
              <StatBox
                icon={<SVGIcons.Gauge />}
                label="Speed"
                value={playerStats.speedKmh}
                unit="km/h"
              />
              <StatBox
                icon={<SVGIcons.Zap />}
                label="Energy"
                value={playerStats.energy}
                unit="%"
              />
              <StatBox
                icon={<SVGIcons.ArrowRightCircle />}
                label="Overtakes"
                value={playerStats.overtakes}
                unit=""
              />
              <StatBox
                icon={<SVGIcons.Flag />}
                label="Pit Stop"
                value={playerStats.pitStop ? "IN PITS" : "NO"}
                unit=""
                highlight={playerStats.pitStop}
              />
            </div>

            {/* Simulation Controls */}
            <div className="flex justify-between items-center border-t border-gray-600 pt-4 mt-4">
              <button
                onClick={() => onSimControl("togglePause")}
                className="p-2 bg-blue-600 hover:bg-blue-500 rounded-full"
                title={isPaused ? "Play" : "Pause"}
              >
                {isPaused ? <SVGIcons.Play /> : <SVGIcons.Pause />}
              </button>
              <div className="flex items-center space-x-2">
                <span className="text-sm">x{simSpeed}</span>
                <button
                  onClick={() => onSimControl("speedUp")}
                  className="p-2 bg-gray-700 hover:bg-gray-600 rounded-full"
                  title="Speed Up"
                >
                  <SVGIcons.FastForward />
                </button>
              </div>
              <button
                onClick={() => onSimControl("reset")}
                className="p-2 bg-red-600 hover:bg-red-500 rounded-full"
                title="Reset"
              >
                <SVGIcons.RefreshCw />
              </button>
            </div>
          </div>
        );
      };

      const StatBox = ({ icon, label, value, unit, highlight = false }) => (
        <div
          className={`flex flex-col items-center justify-center p-3 rounded-md ${
            highlight ? "bg-red-600" : "bg-gray-800"
          }`}
        >
          <div className="flex items-center space-x-2 text-gray-400">
            {icon}
            <span className="text-sm uppercase">{label}</span>
          </div>
          <div className="text-2xl font-bold mt-1">
            {value}
            <span className="text-base ml-1">{unit}</span>
          </div>
        </div>
      );

      /**
       * Main Application Component
       */
      function App() {
        const [cars, setCars] = useState([]);
        const [leaderboard, setLeaderboard] = useState([]);
        const [currentLap, setCurrentLap] = useState(1);
        const [isPaused, setIsPaused] = useState(false);
        const [simSpeed, setSimSpeed] = useState(1);
        const [raceStartTime, setRaceStartTime] = useState(0);
        const [smoothedSpeed, setSmoothedSpeed] = useState(0);

        const pathRef = useRef(null);
        const [pathLength, setPathLength] = useState(0);

        const initializeRace = () => {
          const initialCarState = INITIAL_CAR_DATA.map((car, index) => ({
            ...car,
            progress: (index * 20) / (pathLength || 1000), // Stagger start
            lap: 1,
            totalTime: 0,
            currentSpeed: 0,
            speedKmh: 0,
          }));
          setCars(initialCarState);
          setSmoothedSpeed(0);

          const initialLeaderboard = initialCarState.map((car) => ({
            id: car.id,
            driver: car.driver,
            color: car.color,
            lap: car.lap,
            totalTime: car.totalTime,
          }));
          setLeaderboard(initialLeaderboard);

          setCurrentLap(1);
          setRaceStartTime(performance.now());
          setIsPaused(false);
        };

        useEffect(() => {
          const dummyPath = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "path"
          );
          dummyPath.setAttribute("d", TRACK_PATH_DATA);
          const length = dummyPath.getTotalLength();
          setPathLength(length);
        }, []);

        useEffect(() => {
          if (pathLength > 0) {
            initializeRace();
          }
        }, [pathLength]);
        
        useEffect(() => {
          const playerCar = cars.find((c) => c.id === 1);
          const targetSpeed = playerCar ? playerCar.speedKmh : 0;
          setSmoothedSpeed(prev => prev + (targetSpeed - prev) * 0.1);
        }, [cars]);

        const runSimulation = (deltaTime) => {
          setCars((prevCars) => {
            if (isPaused || pathLength === 0) {
              return prevCars;
            }
            
            const raceIsOver = prevCars.every((c) => c.lap > TOTAL_LAPS);
            if (raceIsOver) {
              setIsPaused(true);
              return prevCars;
            }

            const effectiveDeltaTime = deltaTime;
            const now = performance.now();
            let maxLap = 0;

            const newCars = prevCars.map((car) => {
              if (car.lap > TOTAL_LAPS) {
                maxLap = Math.max(maxLap, car.lap);
                return car; 
              }

              const speedFluctuation = (Math.random() - 0.5) * car.speedVariation;
              const currentSpeed = (car.baseSpeed + speedFluctuation) * simSpeed;
              const speedKmh = Math.round(currentSpeed * 200); 

              // This was the speed bug fix.
              const distance = currentSpeed * (effectiveDeltaTime / 16.67); // Normalized distance
              let newProgress = car.progress + distance;
              let newLap = car.lap;
              let newTotalTime = now - raceStartTime;

              if (newProgress >= pathLength) {
                newProgress = newProgress % pathLength;
                newLap += 1;
              }

              maxLap = Math.max(maxLap, newLap);

              return {
                ...car,
                progress: newProgress,
                lap: newLap,
                totalTime: newTotalTime,
                currentSpeed: currentSpeed,
                speedKmh: speedKmh,
              };
            });
            
            setLeaderboard(
              newCars.map((car) => ({
                id: car.id,
                driver: car.driver,
                color: car.color,
                lap: car.lap,
                totalTime: car.totalTime,
              }))
            );
            setCurrentLap(Math.min(maxLap, TOTAL_LAPS));
            
            return newCars;
          });
        };

        useGameLoop(runSimulation, !isPaused);

        const handleSimControl = (action) => {
          switch (action) {
            case "togglePause":
              setIsPaused((p) => !p);
              break;
            case "speedUp":
              setSimSpeed((s) => (s >= 4 ? 1 : s * 2));
              break;
            case "reset":
              initializeRace();
              break;
          }
        };

        const carElements = useMemo(() => {
          if (!pathRef.current) return null;
          const path = pathRef.current;

          return cars.map((car) => {
            if (car.lap > TOTAL_LAPS) return null;
            const point = path.getPointAtLength(car.progress);
            const lookAheadPoint = path.getPointAtLength(
              (car.progress + 5) % pathLength
            );
            const angle =
              Math.atan2(
                lookAheadPoint.y - point.y,
                lookAheadPoint.x - point.x
              ) *
              (180 / Math.PI);

            return (
              <Car
                key={car.id}
                x={point.x}
                y={point.y}
                rotation={angle}
                color={car.color}
                driverName={car.driver}
              />
            );
          });
        }, [cars, pathLength]);

        if (pathLength === 0) {
          return (
            <div className="flex items-center justify-center w-screen h-screen bg-gray-900 text-white">
              Loading Simulator...
            </div>
          );
        }

        return (
          <div className="relative w-screen h-screen bg-gray-800 overflow-hidden font-sans">
            <div className="absolute top-4 left-1/2 -translate-x-1/2 z-10 flex flex-col items-center">
              <div className="flex items-center space-x-3 bg-gray-900 bg-opacity-70 backdrop-blur-sm p-3 rounded-lg shadow-lg border border-gray-700">
                <SVGIcons.Flag />
                <h1 className="text-2xl font-bold text-white uppercase tracking-wider font-mono">
                  Eclipse Racing Simulator
                </h1>
              </div>
              <h2 className="text-sm font-bold text-white uppercase tracking-wide font-mono mt-1 opacity-75">
                Monza
              </h2>
            </div>


            <RaceTrack>
              <path
                ref={pathRef}
                d={TRACK_PATH_DATA}
                fill="none"
                stroke="none"
              />
              {carElements}
            </RaceTrack>

            <RaceHUD
              lap={currentLap}
              leaderboard={leaderboard}
              playerCar={cars.find((c) => c.id === 1)}
              onSimControl={handleSimControl}
              simSpeed={simSpeed}
              isPaused={isPaused}
            />

            <div 
              className="absolute bottom-10 left-10 text-white font-mono"
              style={{ transform: "scale(0.5)", transformOrigin: "bottom left" }}
            >
              <h2 className="text-7xl font-bold">
                {Math.round(smoothedSpeed)}
                <span className="text-3xl ml-2">km/h</span>
              </h2>
              <div className="w-full h-2 bg-gray-700 rounded-full mt-2 overflow-hidden">
                <div
                  className="h-full bg-gradient-to-r from-cyan-400 to-blue-600 rounded-full transition-all duration-100"
                  style={{
                    width: `${
                      Math.round( smoothedSpeed) / 3
                    }%`,
                  }}
                ></div>
              </div>
            </div>
          </div>
        );
      }

      // 5. Render the app
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>

